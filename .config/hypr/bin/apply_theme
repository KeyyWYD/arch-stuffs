#!/usr/bin/env bash

# OH MY P-C-C-C-C-C

# Appearance settings
mode="dark"
# Mode for theme: 'light' or 'dark'
scheme="scheme-content"
# Scheme Options: scheme-content, scheme-expressive,
# scheme-fidelity, scheme-fruit-salad, scheme-monochrome,
# scheme-neutral, scheme-rainbow, scheme-tonal-spot.
contrast="0"
# Contrast level: -1 to 1

# Vars
monitor=$(hyprctl monitors | awk '/^Monitor/{name=$2} /focused: yes/{print name}')
cache_file="$HOME/.cache/swww/$monitor"
progs=('waybar') # Kill these

is_active() {
  pgrep -x "$1" &> /dev/null
}

start() {
  nohup "$1" > /dev/null &
}

stop() {
  pkill -f "$1" 2> /dev/null
}

#
# Main
#

matugen image "$(cat "$cache_file")" -m "$mode" -t "$scheme" --contrast "$contrast"

for proc in "${progs[@]}"; do
  if is_active "$proc"; then
    stop "$proc"
  fi
done

while true; do
  stopped=true
  for proc in "${progs[@]}"; do
    if is_active "$proc"; then
      stopped=false
      break
    fi
  done
  if [ "$stopped" = true ]; then
    break
  fi
  sleep 0.1
done

for proc in "${progs[@]}"; do
  start "$proc"
done

sleep 0.1
hyprctl reload config-only > /dev/null && killall dunst
