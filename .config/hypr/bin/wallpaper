#!/bin/bash

# File and folder names
wallDIR="$HOME/Pictures/Wallpapers"
cache_dir="$HOME/.cache/swww/"
wltmp="$cache_dir/wltmp"
blurred_wp="$cache_dir/blurred.png"

# Vars
blur="50x30"
current_monitor=$(hyprctl monitors | awk '/^Monitor/{name=$2} /focused: yes/{print name}')
images=($(find "${wallDIR}" -type f \( -iname \*.jpg -o -iname \*.jpeg -o -iname \*.png -o -iname \*.gif \)))
rofi_cmd="rofi -i -show -dmenu -config $HOME/.config/rofi/wallpaper.rasi"

# Sorting Wallpapers
menu() {
  sorted_options=($(printf '%s\n' "${images[@]}" | sort))

  for pic_path in "${sorted_options[@]}"; do
    pic_name=$(basename "$pic_path")

    # Display .gif to indicate animated images
    if [[ -z $(echo "$pic_name" | grep -i "\.gif$") ]]; then
      printf "%s\x00icon\x1f%s\n" "$(echo "$pic_name" | cut -d. -f1)" "$pic_path"
    else
      printf "%s\n" "$pic_name"
    fi
  done
}

main() {
  choice=$(menu | ${rofi_cmd})

  if [[ -z $choice ]]; then
    exit 0
  fi

  pic_index=-1
  for i in "${!images[@]}"; do
    filename=$(basename "${images[$i]}")
    if [[ "$filename" == "$choice"* ]]; then
      pic_index=$i
      break
    fi
  done

  if [[ $pic_index -ne -1 ]]; then
    swww img -o $current_monitor "${images[$pic_index]}" \
	--transition-fps 60 \
	--transition-type "any" \
	--transition-duration 2

    # copy and create blurred wallpaper
    cp "${images[$pic_index]}" $wltmp
    magick $wltmp -resize 75%\! $wltmp
    if [ ! "$blur" == "0x0" ] ; then
      magick $wltmp -blur $blur $blurred_wp
      rm -rf $wltmp
    fi
  fi
}

swww query || swww-daemon --format xrgb
main
apply_theme
