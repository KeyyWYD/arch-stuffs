#!/usr/bin/env python

import requests
import os
import time

CACHE_FILE = ".cache/weather_cache.txt"
CACHE_EXPIRATION = 1200  # Cache expires after 20mins (in seconds)

def get_weather(location):
    url = f"https://wttr.in/{location}?format=%l+%c|%C"
    
    # Check if cached data is valid and return it if present
    cached_data = read_cache()
    if cached_data and time.time() - cached_data["timestamp"] < CACHE_EXPIRATION:
        return cached_data["data"]

    try:
        response = requests.get(url, timeout=5)
        response.raise_for_status()
        weather_data = response.text.strip()
        write_cache(weather_data)
        return weather_data
    except requests.RequestException:
        return None

def read_cache():
    try:
        with open(CACHE_FILE, "r") as file:
            cached_data = file.read().strip()
            if cached_data:
                timestamp, data = cached_data.split("\n", 1)
                return {"timestamp": float(timestamp), "data": data}
            else:
                return None
    except FileNotFoundError:
        return None

def write_cache(weather_data):
    try:
        with open(CACHE_FILE, "w") as file:
            file.write(f"{time.time()}\n{weather_data}")
    except IOError:
        pass  # Handle the error gracefully; optionally, you can log it.

def main():
    location = ""  # Replace with your desired location
    weather_data = get_weather(location)
    if weather_data:
        print(weather_data)

if __name__ == "__main__":
    main()
